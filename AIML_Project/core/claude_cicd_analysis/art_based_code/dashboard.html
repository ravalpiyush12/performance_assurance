<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CI/CD NFT Test Analysis Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e3a8a 50%, #0f172a 100%);
            color: #e2e8f0;
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 1600px; margin: 0 auto; }
        .header {
            text-align: center;
            margin-bottom: 20px;
            padding: 30px;
            background: rgba(30, 41, 59, 0.5);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            border: 1px solid rgba(59, 130, 246, 0.3);
        }
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            background: linear-gradient(90deg, #60a5fa, #a78bfa);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .connection-status {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9em;
            margin-top: 10px;
        }
        .status-connected { background: rgba(34, 197, 94, 0.2); border: 1px solid rgba(34, 197, 94, 0.5); color: #4ade80; }
        .status-disconnected { background: rgba(239, 68, 68, 0.2); border: 1px solid rgba(239, 68, 68, 0.5); color: #f87171; }
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid rgba(59, 130, 246, 0.3); }
        .tab {
            padding: 15px 30px;
            background: rgba(30, 41, 59, 0.3);
            border: none;
            border-radius: 10px 10px 0 0;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            color: #94a3b8;
            transition: all 0.3s;
        }
        .tab:hover { background: rgba(59, 130, 246, 0.2); color: #60a5fa; }
        .tab.active { background: rgba(59, 130, 246, 0.3); color: #60a5fa; border-bottom: 3px solid #3b82f6; }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .controls { display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; align-items: center; }
        .control-group { display: flex; gap: 10px; align-items: center; }
        .control-label { color: #94a3b8; font-weight: 600; }
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
            background: rgba(59, 130, 246, 0.2);
            color: #60a5fa;
            border: 1px solid rgba(59, 130, 246, 0.5);
        }
        .btn:hover { background: rgba(59, 130, 246, 0.3); transform: translateY(-2px); }
        .btn.active { background: #3b82f6; color: white; }
        .btn-refresh { background: rgba(34, 197, 94, 0.2); color: #4ade80; border-color: rgba(34, 197, 94, 0.5); }
        select {
            padding: 12px 20px;
            background: rgba(30, 41, 59, 0.8);
            border: 1px solid rgba(59, 130, 246, 0.5);
            border-radius: 8px;
            color: #e2e8f0;
            font-size: 14px;
            cursor: pointer;
        }
        .alert {
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .alert-critical { background: rgba(239, 68, 68, 0.2); border: 1px solid rgba(239, 68, 68, 0.5); }
        .alert-warning { background: rgba(251, 146, 60, 0.2); border: 1px solid rgba(251, 146, 60, 0.5); }
        .metrics-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .metric-card {
            background: rgba(30, 41, 59, 0.5);
            backdrop-filter: blur(10px);
            padding: 25px;
            border-radius: 15px;
            border: 1px solid rgba(59, 130, 246, 0.3);
            transition: all 0.3s;
        }
        .metric-card:hover { transform: translateY(-5px); box-shadow: 0 10px 30px rgba(59, 130, 246, 0.3); }
        .metric-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .metric-badge { padding: 4px 12px; border-radius: 20px; font-size: 11px; font-weight: 700; }
        .badge-high { background: rgba(239, 68, 68, 0.3); color: #fca5a5; }
        .badge-medium { background: rgba(251, 146, 60, 0.3); color: #fdba74; }
        .badge-low { background: rgba(34, 197, 94, 0.3); color: #86efac; }
        .metric-value { font-size: 2.5em; font-weight: 700; margin-bottom: 5px; }
        .metric-label { color: #94a3b8; font-size: 0.9em; }
        .metric-detail { margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(148, 163, 184, 0.2); font-size: 0.85em; color: #cbd5e1; }
        .chart-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(500px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .chart-container { background: rgba(30, 41, 59, 0.5); backdrop-filter: blur(10px); padding: 25px; border-radius: 15px; border: 1px solid rgba(59, 130, 246, 0.3); }
        .chart-title { font-size: 1.3em; margin-bottom: 20px; font-weight: 600; }
        .table-container { background: rgba(30, 41, 59, 0.5); backdrop-filter: blur(10px); padding: 25px; border-radius: 15px; border: 1px solid rgba(59, 130, 246, 0.3); margin-bottom: 20px; overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; }
        th { background: rgba(59, 130, 246, 0.2); padding: 12px; text-align: left; font-weight: 600; border-bottom: 2px solid rgba(59, 130, 246, 0.5); }
        td { padding: 12px; border-bottom: 1px solid rgba(148, 163, 184, 0.2); }
        tr:hover { background: rgba(59, 130, 246, 0.1); }
        .status-indicator { display: inline-block; width: 10px; height: 10px; border-radius: 50%; margin-right: 8px; }
        .status-increasing { background: #ef4444; box-shadow: 0 0 8px #ef4444; }
        .status-stable { background: #eab308; box-shadow: 0 0 8px #eab308; }
        .status-decreasing { background: #22c55e; box-shadow: 0 0 8px #22c55e; }
        .info-box { background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 10px; padding: 15px; margin-bottom: 20px; }
        .info-box h4 { color: #60a5fa; margin-bottom: 10px; }
        .loading { text-align: center; padding: 40px; }
        .spinner { border: 3px solid rgba(59, 130, 246, 0.3); border-top: 3px solid #3b82f6; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ CI/CD NFT Test Analysis Dashboard</h1>
            <p>Predictive Analytics & Real-time Monitoring | Daily Runs: 12PM - 2PM EST</p>
            <div id="connectionStatus" class="connection-status status-disconnected">üî¥ Connecting...</div>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('executive')">üìä Executive View</button>
            <button class="tab" onclick="switchTab('art')">üéØ ART Specific View</button>
        </div>

        <!-- Executive View -->
        <div id="executive-tab" class="tab-content active">
            <div class="controls">
                <div class="control-group">
                    <span class="control-label">Time Range:</span>
                    <button class="btn" onclick="loadData(2)">2 Days</button>
                    <button class="btn active" onclick="loadData(7)">7 Days</button>
                    <button class="btn" onclick="loadData(15)">15 Days</button>
                    <button class="btn" onclick="loadData(30)">30 Days</button>
                </div>
                <button class="btn btn-refresh" onclick="refreshData()">üîÑ Refresh</button>
            </div>

            <div id="alerts" class="alerts-section"></div>
            <div class="info-box">
                <h4>üìà Prediction Model Info</h4>
                <p id="predictionInfo">Loading...</p>
            </div>

            <div class="metrics-grid" id="metrics"></div>

            <div class="chart-grid">
                <div class="chart-container">
                    <h3 class="chart-title">Failure Rate Trend</h3>
                    <canvas id="failureChart"></canvas>
                </div>
                <div class="chart-container">
                    <h3 class="chart-title">P95 Response Time</h3>
                    <canvas id="performanceChart"></canvas>
                </div>
            </div>

            <div class="chart-grid">
                <div class="chart-container">
                    <h3 class="chart-title">API Failures</h3>
                    <canvas id="apiChart"></canvas>
                </div>
                <div class="chart-container">
                    <h3 class="chart-title">Test Distribution</h3>
                    <canvas id="pieChart"></canvas>
                </div>
            </div>

            <div class="table-container">
                <h3 class="chart-title">API Analysis</h3>
                <table id="apiTable"></table>
            </div>

            <div class="table-container">
                <h3 class="chart-title">Instability Hotspots</h3>
                <table id="instabilityTable"></table>
            </div>
        </div>

        <!-- ART Specific View -->
        <div id="art-tab" class="tab-content">
            <div class="controls">
                <div class="control-group">
                    <span class="control-label">Select ART:</span>
                    <select id="artSelector" onchange="loadArtData()">
                        <option value="">-- Select ART --</option>
                    </select>
                </div>
                <div class="control-group">
                    <span class="control-label">Time Range:</span>
                    <button class="btn" onclick="currentArtDays=2; loadArtData()">2 Days</button>
                    <button class="btn active" onclick="currentArtDays=7; loadArtData()">7 Days</button>
                    <button class="btn" onclick="currentArtDays=15; loadArtData()">15 Days</button>
                    <button class="btn" onclick="currentArtDays=30; loadArtData()">30 Days</button>
                </div>
            </div>

            <div id="artMetrics" class="metrics-grid"></div>

            <div class="chart-grid">
                <div class="chart-container">
                    <h3 class="chart-title">ART Failure Trend</h3>
                    <canvas id="artFailureChart"></canvas>
                </div>
                <div class="chart-container">
                    <h3 class="chart-title">ART Performance</h3>
                    <canvas id="artPerfChart"></canvas>
                </div>
            </div>

            <div class="table-container">
                <h3 class="chart-title">APIs under this ART</h3>
                <table id="artApiTable"></table>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:5000/api';
        let currentDays = 7;
        let currentArtDays = 7;
        let charts = {};

        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            
            if (tabName === 'executive') {
                document.querySelectorAll('.tab')[0].classList.add('active');
                document.getElementById('executive-tab').classList.add('active');
            } else {
                document.querySelectorAll('.tab')[1].classList.add('active');
                document.getElementById('art-tab').classList.add('active');
                loadArtList();
            }
        }

        async function checkConnection() {
            try {
                const response = await fetch(`${API_BASE}/health`);
                const data = await response.json();
                if (data.status === 'ok') {
                    document.getElementById('connectionStatus').className = 'connection-status status-connected';
                    document.getElementById('connectionStatus').innerHTML = 'üü¢ Connected';
                    return true;
                }
            } catch (error) {
                document.getElementById('connectionStatus').className = 'connection-status status-disconnected';
                document.getElementById('connectionStatus').innerHTML = 'üî¥ Disconnected';
                return false;
            }
        }

        async function loadData(days = 7) {
            currentDays = days;
            if (!await checkConnection()) return;

            document.querySelectorAll('#executive-tab .control-group:first-child .btn').forEach((btn, idx) => {
                btn.classList.remove('active');
                if ([2,7,15,30][idx] === days) btn.classList.add('active');
            });

            try {
                const response = await fetch(`${API_BASE}/dashboard?days=${days}`);
                const data = await response.json();
                if (data.status === 'success') {
                    renderAlerts(data.alerts);
                    renderPredictionInfo(data.predictions);
                    renderMetrics(data);
                    renderCharts(data);
                    renderTables(data);
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        function renderPredictionInfo(pred) {
            const info = document.getElementById('predictionInfo');
            if (pred.trend === 'insufficient_data') {
                info.innerHTML = `‚ö†Ô∏è Need at least 3 days of data. Currently: ${pred.data_points || 0} day(s)`;
            } else {
                info.innerHTML = `Confidence: ${pred.confidence}% | Data: ${pred.data_points} days | Trend: ${pred.trend} | Next Day: ${pred.next_day_prediction}%`;
            }
        }

        function renderAlerts(alerts) {
            const container = document.getElementById('alerts');
            if (!alerts || alerts.length === 0) {
                container.innerHTML = '<div class="alert" style="background: rgba(34, 197, 94, 0.2); border: 1px solid rgba(34, 197, 94, 0.5);"><span>‚úÖ</span><div><strong>All Systems Operational</strong></div></div>';
                return;
            }
            container.innerHTML = alerts.map(a => `<div class="alert alert-${a.type}"><span>${a.type==='critical'?'üö®':'‚ö†Ô∏è'}</span><div><strong>${a.category}</strong><br>${a.message}</div></div>`).join('');
        }

        function renderMetrics(data) {
            const pred = data.predictions;
            const latest = data.daily_metrics[data.daily_metrics.length - 1];
            let badge = pred.next_day_prediction > 7 ? 'high' : pred.next_day_prediction > 4 ? 'medium' : 'low';
            let text = pred.next_day_prediction > 7 ? 'HIGH RISK' : pred.next_day_prediction > 4 ? 'MEDIUM' : 'LOW RISK';

            document.getElementById('metrics').innerHTML = `
                <div class="metric-card">
                    <div class="metric-header"><span style="font-size:28px">üìä</span><span class="metric-badge badge-${badge}">${text}</span></div>
                    <div class="metric-value">${pred.next_day_prediction}%</div>
                    <div class="metric-label">Predicted Failure (24h)</div>
                    <div class="metric-detail">Trend: ${pred.trend} | Confidence: ${pred.confidence}%</div>
                </div>
                <div class="metric-card">
                    <div class="metric-header"><span style="font-size:28px">‚úÖ</span></div>
                    <div class="metric-value" style="color:#22c55e">${latest.PASS_COUNT}</div>
                    <div class="metric-label">Tests Passed</div>
                </div>
                <div class="metric-card">
                    <div class="metric-header"><span style="font-size:28px">‚ùå</span></div>
                    <div class="metric-value" style="color:#ef4444">${latest.FAILURES}</div>
                    <div class="metric-label">Tests Failed</div>
                </div>
                <div class="metric-card">
                    <div class="metric-header"><span style="font-size:28px">‚ö°</span></div>
                    <div class="metric-value">${latest.P95_RESPONSE_TIME.toFixed(0)}ms</div>
                    <div class="metric-label">P95 Response Time</div>
                </div>
            `;
        }

        function renderCharts(data) {
            if (charts.failure) charts.failure.destroy();
            charts.failure = new Chart(document.getElementById('failureChart'), {
                type: 'line',
                data: {
                    labels: data.daily_metrics.map(d => d.TEST_DATE),
                    datasets: [{label: 'Failure Rate %', data: data.daily_metrics.map(d => d.FAILURE_RATE), borderColor: '#ef4444', fill: true, backgroundColor: 'rgba(239,68,68,0.1)'}]
                },
                options: {responsive: true, plugins: {legend: {labels: {color: '#e2e8f0'}}}, scales: {y: {ticks: {color: '#94a3b8'}}, x: {ticks: {color: '#94a3b8'}}}}
            });

            if (charts.perf) charts.perf.destroy();
            charts.perf = new Chart(document.getElementById('performanceChart'), {
                type: 'line',
                data: {
                    labels: data.performance.data.map(d => d.TEST_DATE),
                    datasets: [{label: 'P95 ms', data: data.performance.data.map(d => d.P95_RESPONSE_TIME), borderColor: '#3b82f6', fill: true, backgroundColor: 'rgba(59,130,246,0.1)'}]
                },
                options: {responsive: true, plugins: {legend: {labels: {color: '#e2e8f0'}}}, scales: {y: {ticks: {color: '#94a3b8'}}, x: {ticks: {color: '#94a3b8'}}}}
            });

            if (charts.api) charts.api.destroy();
            const apis = data.api_failures.slice(0, 8);
            charts.api = new Chart(document.getElementById('apiChart'), {
                type: 'bar',
                data: {labels: apis.map(a => a.api), datasets: [{label: 'Failures', data: apis.map(a => a.failures), backgroundColor: apis.map(a => a.severity==='high'?'#ef4444':a.severity==='medium'?'#fb923c':'#eab308')}]},
                options: {responsive: true, plugins: {legend: {labels: {color: '#e2e8f0'}}}, scales: {y: {ticks: {color: '#94a3b8'}}, x: {ticks: {color: '#94a3b8', maxRotation: 45}}}}
            });

            if (charts.pie) charts.pie.destroy();
            const latest = data.daily_metrics[data.daily_metrics.length - 1];
            charts.pie = new Chart(document.getElementById('pieChart'), {
                type: 'doughnut',
                data: {labels: ['Passed', 'Failed'], datasets: [{data: [latest.PASS_COUNT, latest.FAILURES], backgroundColor: ['#22c55e', '#ef4444']}]},
                options: {responsive: true, plugins: {legend: {labels: {color: '#e2e8f0'}}}}
            });
        }

        function renderTables(data) {
            document.getElementById('apiTable').innerHTML = `
                <thead><tr><th>API</th><th>Failures</th><th>Rate</th><th>P95</th><th>Trend</th><th>Severity</th></tr></thead>
                <tbody>${data.api_failures.slice(0,10).map(a => `<tr><td>${a.api}</td><td>${a.failures}</td><td>${a.failure_rate}%</td><td>${a.p95_response_time}ms</td><td><span class="status-indicator status-${a.trend}"></span>${a.trend}</td><td><span class="metric-badge badge-${a.severity==='high'?'high':'medium'}">${a.severity.toUpperCase()}</span></td></tr>`).join('')}</tbody>
            `;

            document.getElementById('instabilityTable').innerHTML = `
                <thead><tr><th>Identifier</th><th>Score</th><th>Avg Failures</th><th>Variance</th></tr></thead>
                <tbody>${data.instability_hotspots.map(h => `<tr><td>${h.identifier}</td><td><span class="metric-badge badge-${h.instability_score>8?'high':'medium'}">${h.instability_score}</span></td><td>${h.avg_failures}</td><td>${h.variance}</td></tr>`).join('')}</tbody>
            `;
        }

        async function loadArtList() {
            try {
                const response = await fetch(`${API_BASE}/arts`);
                const data = await response.json();
                if (data.status === 'success') {
                    const selector = document.getElementById('artSelector');
                    selector.innerHTML = '<option value="">-- Select ART --</option>' + data.arts.map(art => `<option value="${art}">${art}</option>`).join('');
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        async function loadArtData() {
            const artName = document.getElementById('artSelector').value;
            if (!artName) return;

            try {
                const response = await fetch(`${API_BASE}/art/${encodeURIComponent(artName)}?days=${currentArtDays}`);
                const result = await response.json();
                if (result.status === 'success') {
                    const data = result.data;
                    document.getElementById('artMetrics').innerHTML = `
                        <div class="metric-card"><div class="metric-value">${data.summary.total_tests}</div><div class="metric-label">Total Tests</div></div>
                        <div class="metric-card"><div class="metric-value" style="color:#22c55e">${data.summary.total_passes}</div><div class="metric-label">Passed</div></div>
                        <div class="metric-card"><div class="metric-value" style="color:#ef4444">${data.summary.total_failures}</div><div class="metric-label">Failed</div></div>
                        <div class="metric-card"><div class="metric-value">${data.summary.avg_p95}ms</div><div class="metric-label">Avg P95</div></div>
                    `;

                    if (charts.artFailure) charts.artFailure.destroy();
                    charts.artFailure = new Chart(document.getElementById('artFailureChart'), {
                        type: 'line',
                        data: {labels: data.daily_metrics.map(d => d.TEST_DATE), datasets: [{label: 'Failure Rate', data: data.daily_metrics.map(d => d.FAILURE_RATE), borderColor: '#ef4444', fill: true, backgroundColor: 'rgba(239,68,68,0.1)'}]},
                        options: {responsive: true, plugins: {legend: {labels: {color: '#e2e8f0'}}}, scales: {y: {ticks: {color: '#94a3b8'}}, x: {ticks: {color: '#94a3b8'}}}}
                    });

                    if (charts.artPerf) charts.artPerf.destroy();
                    charts.artPerf = new Chart(document.getElementById('artPerfChart'), {
                        type: 'line',
                        data: {labels: data.daily_metrics.map(d => d.TEST_DATE), datasets: [{label: 'P95 ms', data: data.daily_metrics.map(d => d.P95_RESPONSE_TIME), borderColor: '#3b82f6', fill: true, backgroundColor: 'rgba(59,130,246,0.1)'}]},
                        options: {responsive: true, plugins: {legend: {labels: {color: '#e2e8f0'}}}, scales: {y: {ticks: {color: '#94a3b8'}}, x: {ticks: {color: '#94a3b8'}}}}
                    });

                    document.getElementById('artApiTable').innerHTML = `
                        <thead><tr><th>API</th><th>Passes</th><th>Failures</th><th>Failure Rate</th><th>P95</th></tr></thead>
                        <tbody>${data.apis.map(a => `<tr><td>${a.API}</td><td>${a.PASS_COUNT}</td><td>${a.FAILURES}</td><td>${a.FAILURE_RATE}%</td><td>${a.P95_RESPONSE_TIME.toFixed(0)}ms</td></tr>`).join('')}</tbody>
                    `;
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        function refreshData() { loadData(currentDays); }

        window.onload = async () => {
            if (await checkConnection()) {
                await loadData(7);
                setInterval(() => checkConnection(), 60000);
            }
        };
    </script>
</body>
</html>