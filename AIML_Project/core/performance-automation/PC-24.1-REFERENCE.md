# PC 24.1 Jenkins Automation - Verified Working Configuration

## âœ… VERIFIED WORKING ENDPOINTS

### Authentication
```
POST /LoadTest/rest/authentication-point/authenticate
Content-Type: application/json
Body: {"Token":"BASE64_ENCODED_USERNAME:PASSWORD"}

Returns: Cookies in Set-Cookie headers
```

### Trigger Test
```
POST /LoadTest/rest/domains/{DOMAIN}/projects/{PROJECT}/Runs
Content-Type: application/xml

Body:
<?xml version="1.0" encoding="UTF-8"?>
<Run xmlns="http://www.hp.com/PC/REST/API">
    <TestID>1</TestID>
    <TestInstanceID>AUTO</TestInstanceID>
    <Duration>
        <Hours>0</Hours>
        <Minutes>10</Minutes>
    </Duration>
    <PostRunAction>Collate and Analyze</PostRunAction>
    <VudsMode>false</VudsMode>
</Run>

Returns: XML with <ID>runId</ID>
```

### Monitor Test
```
GET /LoadTest/rest/domains/{DOMAIN}/projects/{PROJECT}/Runs/{RUN_ID}
Accept: application/xml

Returns: XML with <RunState>status</RunState>
```

### Get Results List
```
GET /LoadTest/rest/domains/{DOMAIN}/projects/{PROJECT}/Runs/{RUN_ID}/Results
Accept: application/xml

Returns: XML with <Result><ID>resultId</ID></Result>
```

### Download Report (VERIFIED!)
```
GET /LoadTest/rest/domains/{DOMAIN}/projects/{PROJECT}/Runs/{RUN_ID}/Results/{RESULT_ID}/data
Cookie: LWSSO_COOKIE_KEY=...

Returns: Binary ZIP file (Report.zip)
```

## ğŸ”‘ Key Points

### 1. Endpoint Structure
- **Critical:** URL must end with `/data`
- **Format:** `/Runs/{RUN_ID}/Results/{RESULT_ID}/data`
- **Capital R:** Use `Runs` and `Results` (capital R)

### 2. Cookie Handling
- Extract cookies from authentication response
- Pass as `Cookie: LWSSO_COOKIE_KEY=...` header
- Note: In Python requests library, use `cookies` parameter, not `headers`

### 3. Duration Format
- **Not:** `<TimeslotDuration>600</TimeslotDuration>`
- **But:** `<Duration><Hours>0</Hours><Minutes>10</Minutes></Duration>`

### 4. PostRunAction Format
- **Not:** `COLLATE_AND_ANALYZE` (enum)
- **But:** `Collate and Analyze` (exact string with spaces)

## ğŸ“‹ Complete Flow

```
1. Authenticate
   â†’ Get cookie

2. Trigger Test
   POST /Runs with XML payload
   â†’ Get Run ID

3. Monitor Test
   GET /Runs/{RUN_ID}
   Poll until <RunState> = FINISHED

4. Get Results List
   GET /Runs/{RUN_ID}/Results
   â†’ Extract Result ID from XML

5. Download Report
   GET /Runs/{RUN_ID}/Results/{RESULT_ID}/data
   â†’ Save as Report.zip

6. Extract Report
   unzip Report.zip
   â†’ Find index.html or report.html
```

## ğŸ› Common Issues & Solutions

### Issue: 400 Bad Request on Download
**Solution:** Ensure endpoint ends with `/data`

### Issue: Empty or Small File
**Possible Causes:**
- Result not ready (post-run action incomplete)
- Wrong Result ID
- Cookie expired

### Issue: Authentication Works but Download Fails
**Solution:** 
- Verify Run ID and Result ID are correct
- Check that test has completed and post-run action finished
- Ensure cookie is still valid

### Issue: curl Not Downloading
**Solution:**
- Remove `-i` flag (includes headers in output)
- Remove `-H "Accept: application/octet-stream"` (not needed)
- Use simple cookie header: `-H "Cookie: ${COOKIE}"`

## ğŸ“Š Expected Console Output

```
Authentication:
âœ“ Base64 token generated (length: 24)
âœ“ Authentication successful!
âœ“ Cookies extracted (length: 156)

Trigger Test:
âœ“ Test triggered successfully!
Run ID: 12345

Monitor:
[14:30:00] Check #1 (0m 0s) - RunState: INITIALIZING
[14:30:30] Check #2 (0m 30s) - RunState: RUNNING
...
[14:40:00] Check #20 (10m 0s) - RunState: FINISHED
âœ“ Test completed successfully!

Download:
Result ID: 67890
Endpoint: /LoadTest/rest/.../Runs/12345/Results/67890/data
Starting download...
HTTP_CODE:200
SIZE_DOWNLOAD:2456789
Report.zip size: 2456789 bytes
File type: Zip archive data
âœ“ Valid ZIP file downloaded!

Extract:
Extracting Report.zip...
Extracted files:
  index.html
  report.html
  styles.css
âœ“ Main report found: index.html
```

## ğŸ¯ Curl Command That Works

```bash
curl -k -s \
  "https://${PC_HOST}:${PC_PORT}/LoadTest/rest/domains/${DOMAIN}/projects/${PROJECT}/Runs/${RUN_ID}/Results/${RESULT_ID}/data" \
  -H "Cookie: ${COOKIE}" \
  -o Report.zip
```

**Key Points:**
- `-k` for self-signed SSL certificates
- `-s` for silent mode
- Quote the URL to handle special characters
- Simple Cookie header (not as dictionary)
- No Accept header needed

## ğŸ“ Files Generated

```
${WORKSPACE}/results/
â”œâ”€â”€ pc_cookie.txt              # Authentication cookie
â”œâ”€â”€ run_id.txt                 # Run ID
â”œâ”€â”€ result_id.txt              # Result ID
â”œâ”€â”€ final_status.txt           # Test status
â”œâ”€â”€ trigger_payload.xml        # Test trigger request
â”œâ”€â”€ trigger_response.xml       # Test trigger response
â”œâ”€â”€ results_list.xml           # Results list response
â”œâ”€â”€ Report.zip                 # Downloaded PC report
â”œâ”€â”€ download_output.txt        # Download stats
â”œâ”€â”€ performance_report.html    # Jenkins summary
â”œâ”€â”€ summary.txt                # Text summary
â””â”€â”€ [extracted HTML files]     # Unzipped PC reports
```

## ğŸš€ Production Ready

This configuration has been verified and works with PC 24.1. Use **Jenkinsfile-PC-24.1-PRODUCTION** for deployment.

### Jenkins Parameters:
- PC_HOST: Performance Center hostname (no https://)
- PC_PORT: 443 (for HTTPS)
- PC_DOMAIN: DEFAULT
- PC_PROJECT: Project name (exact match, case-sensitive)
- TEST_ID: Numeric test ID
- TEST_DURATION: Seconds (converted to Hours/Minutes)
- POST_RUN_ACTION: "Collate and Analyze"
- EMAIL_RECIPIENTS: Comma-separated email addresses

---

**Last Updated:** Based on verified working Python script
**PC Version:** 24.1
**Status:** Production Ready âœ…
